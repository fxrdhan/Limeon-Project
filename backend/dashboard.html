<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini API Metrics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
            box-sizing: border-box;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .metric-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            height: 400px;
            position: relative;
        }
        .chart-wrapper {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
            max-height: 600px;
            overflow-y: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
            word-wrap: break-word;
            overflow: hidden;
        }
        th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        .status-success {
            color: #28a745;
            font-weight: bold;
        }
        .status-error {
            color: #dc3545;
            font-weight: bold;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        .danger {
            background: #dc3545;
        }
        .danger:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Gemini API Metrics Dashboard</h1>
            <button onclick="refreshData()">Refresh Data</button>
            <button onclick="clearMetrics()" class="danger">Clear All Metrics</button>
        </div>

        <div class="metrics-grid" id="metricsGrid">
            <!-- Metrics cards will be populated here -->
        </div>

        <div class="chart-container">
            <h3>Request Success Rate</h3>
            <div class="chart-wrapper">
                <canvas id="successChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <h3>Processing Time Trend (Last 20 Requests)</h3>
            <div class="chart-wrapper">
                <canvas id="timeChart"></canvas>
            </div>
        </div>

        <div class="table-container">
            <h3 style="padding: 20px 20px 0 20px; margin: 0;">Recent Requests (Last 20)</h3>
            <table id="requestsTable">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Endpoint</th>
                        <th>Status</th>
                        <th>Processing Time</th>
                        <th>File Size</th>
                        <th>Response Size</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Table rows will be populated here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let successChart, timeChart;

        async function fetchMetrics() {
            try {
                const response = await fetch('/api/metrics');
                return await response.json();
            } catch (error) {
                console.error('Error fetching metrics:', error);
                return null;
            }
        }

        async function fetchRecentRequests() {
            try {
                const response = await fetch('/api/metrics/recent?limit=20');
                const data = await response.json();
                // Ensure we always have exactly 20 data points for consistent X-axis
                return data.slice(-20);
            } catch (error) {
                console.error('Error fetching recent requests:', error);
                return [];
            }
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDuration(ms) {
            return ms + 'ms';
        }

        function updateMetricsCards(metrics) {
            const grid = document.getElementById('metricsGrid');
            grid.innerHTML = `
                <div class="metric-card">
                    <div class="metric-title">Total Requests</div>
                    <div class="metric-value">${metrics.totalRequests}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Success Rate</div>
                    <div class="metric-value">${metrics.totalRequests > 0 ? ((metrics.successfulRequests / metrics.totalRequests) * 100).toFixed(1) : 0}%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Average Processing Time</div>
                    <div class="metric-value">${formatDuration(Math.round(metrics.averageProcessingTime))}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Files Processed</div>
                    <div class="metric-value">${metrics.fileMetrics.totalFilesProcessed}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Average File Size</div>
                    <div class="metric-value">${formatBytes(Math.round(metrics.fileMetrics.averageFileSize))}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Average Response Size</div>
                    <div class="metric-value">${formatBytes(Math.round(metrics.responseMetrics.averageResponseSize))}</div>
                </div>
            `;
        }

        function updateSuccessChart(metrics) {
            const ctx = document.getElementById('successChart').getContext('2d');
            
            if (successChart) {
                // Update existing chart data instead of destroying it
                successChart.data.datasets[0].data = [metrics.successfulRequests, metrics.failedRequests];
                successChart.update('none');
                return;
            }

            successChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Successful', 'Failed'],
                    datasets: [{
                        data: [metrics.successfulRequests, metrics.failedRequests],
                        backgroundColor: ['#28a745', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updateTimeChart(requests) {
            const ctx = document.getElementById('timeChart').getContext('2d');
            
            // Get last 20 requests and create sliding window
            const last20 = requests.slice(-20);
            
            // Create time-based labels instead of sequential numbers
            const labels = last20.map(r => {
                const time = new Date(r.timestamp);
                return time.toLocaleTimeString('id-ID', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                });
            });
            
            if (timeChart) {
                // Update existing chart data instead of destroying it
                timeChart.data.labels = labels;
                timeChart.data.datasets[0].data = last20.map(r => r.processingTime);
                timeChart.update('none'); // Use 'none' for no animation
                return;
            }
            
            timeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Processing Time (ms)',
                        data: last20.map(r => r.processingTime),
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 300
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Processing Time (ms)'
                            },
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time (Last 20 Requests)'
                            },
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 0
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: function(context) {
                                    const index = context[0].dataIndex;
                                    const request = last20[index];
                                    return `${request.endpoint} - ${labels[index]}`;
                                },
                                label: function(context) {
                                    return `Processing Time: ${context.raw}ms`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateRequestsTable(requests) {
            const tbody = document.querySelector('#requestsTable tbody');
            // Always limit to exactly 20 most recent requests
            const last20 = requests.slice(-20);
            tbody.innerHTML = last20.map(req => `
                <tr>
                    <td>${new Date(req.timestamp).toLocaleString('id-ID')}</td>
                    <td>${req.endpoint}</td>
                    <td class="status-${req.status}">${req.status.toUpperCase()}</td>
                    <td>${formatDuration(req.processingTime)}</td>
                    <td>${req.fileSize ? formatBytes(req.fileSize) : '-'}</td>
                    <td>${req.responseSize ? formatBytes(req.responseSize) : '-'}</td>
                </tr>
            `).join('');
        }

        async function refreshData() {
            const metrics = await fetchMetrics();
            const requests = await fetchRecentRequests();
            
            if (metrics) {
                updateMetricsCards(metrics);
                updateSuccessChart(metrics);
                updateTimeChart(requests);
                updateRequestsTable(requests);
            }
        }

        async function clearMetrics() {
            if (confirm('Are you sure you want to clear all metrics? This action cannot be undone.')) {
                try {
                    await fetch('/api/metrics/clear', { method: 'POST' });
                    await refreshData();
                    alert('Metrics cleared successfully!');
                } catch (error) {
                    console.error('Error clearing metrics:', error);
                    alert('Error clearing metrics. Please try again.');
                }
            }
        }

        // Handle window resize to prevent chart overflow
        window.addEventListener('resize', function() {
            if (successChart) {
                successChart.resize();
            }
            if (timeChart) {
                timeChart.resize();
            }
        });

        // Initialize dashboard
        refreshData();
        
        // Auto-refresh every 30 seconds
        setInterval(refreshData, 30000);
    </script>
</body>
</html>