#!/bin/bash
# Konfigurasi Supabase
SUPABASE_URL="https://psqmckbtwqphcteymjil.supabase.co"
SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBzcW1ja2J0d3FwaGN0ZXltamlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDIxOTQ2MjAsImV4cCI6MjA1Nzc3MDYyMH0.wvxpldpaoanDk9Wd7wDUeeCuMSVw9e0pxE7_BMt823s"

# Buat direktori output jika belum ada
OUTPUT_DIR="supabase_data"
mkdir -p "$OUTPUT_DIR"

# File output gabungan
OUTPUT_FILE="$OUTPUT_DIR/database_export.txt"
> "$OUTPUT_FILE"

# Daftar tabel yang diketahui (diperbarui sesuai gambar)
TABLES=(
  "doctors"
  "item_categories"
  "item_types"
  "item_units"
  "items"
  "patients"
  "purchase_items"
  "purchases"
  "sale_items"
  "sales"
  "suppliers"
  "unit_conversions"
  "users"
)

# Loop melalui setiap tabel
for TABLE in "${TABLES[@]}"; do
  echo "Mengunduh data tabel: $TABLE"
  
  # Ambil data dari tabel dan simpan ke file JSON
  RESPONSE=$(curl "$SUPABASE_URL/rest/v1/$TABLE?select=*" \
    -H "apikey: $SUPABASE_KEY" \
    -H "Authorization: Bearer $SUPABASE_KEY" \
    -s)
    
  # Simpan ke file JSON individual
  echo "$RESPONSE" | jq . > "$OUTPUT_DIR/$TABLE.json"
  
  # Tambahkan ke file gabungan
  echo "=== DATA TABEL: $TABLE ===" >> "$OUTPUT_FILE"
  echo "$RESPONSE" | jq . >> "$OUTPUT_FILE"
  echo -e "\n\n" >> "$OUTPUT_FILE"
  
  echo "âœ“ Data $TABLE berhasil diproses"
done

echo "Semua data telah diunduh ke direktori $OUTPUT_DIR"
echo "Ekspor gabungan disimpan di $OUTPUT_FILE"