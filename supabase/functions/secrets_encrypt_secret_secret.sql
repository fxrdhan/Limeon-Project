-- Function: secrets_encrypt_secret_secret
-- Exported from Supabase on: 2025-08-03T03:25:40.290Z

CREATE OR REPLACE FUNCTION vault.secrets_encrypt_secret_secret()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
		BEGIN
		        new.secret = CASE WHEN new.secret IS NULL THEN NULL ELSE
			CASE WHEN new.key_id IS NULL THEN NULL ELSE pg_catalog.encode(
			  pgsodium.crypto_aead_det_encrypt(
				pg_catalog.convert_to(new.secret, 'utf8'),
				pg_catalog.convert_to((new.id::text || new.description::text || new.created_at::text || new.updated_at::text)::text, 'utf8'),
				new.key_id::uuid,
				new.nonce
			  ),
				'base64') END END;
		RETURN new;
		END;
		$function$
;