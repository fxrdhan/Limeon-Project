# Mergify Configuration
# Documentation: https://docs.mergify.com/

pull_request_rules:
  # ü§ñ Auto-merge for Dependabot PRs
  - name: Auto-merge Dependabot PRs when CI passes
    conditions:
      - author=dependabot[bot]
      - check-success=TypeScript Check
      - check-success=Lint Code
      - check-success=Check Formatting
      - check-success=Tests & Coverage
      - check-success=Build Application
      - '#approved-reviews-by>=0'
    actions:
      merge:
        method: squash
        commit_message: title+body
      delete_head_branch: {}
      comment:
        message: |
          ‚úÖ Auto-merged by Mergify
          All checks passed, Dependabot PR has been automatically merged.

  # üè∑Ô∏è Auto-merge for PRs with 'automerge' label
  - name: Auto-merge PRs with automerge label
    conditions:
      - label=automerge
      - check-success=TypeScript Check
      - check-success=Lint Code
      - check-success=Check Formatting
      - check-success=Tests & Coverage
      - check-success=Build Application
      - '#approved-reviews-by>=1'
      - -draft
    actions:
      merge:
        method: squash
        commit_message: title+body
      delete_head_branch: {}
      comment:
        message: |
          ‚úÖ Auto-merged by Mergify
          All checks passed and PR has been approved.

  # üîÑ Auto-update PRs when base branch changes
  - name: Auto-update PRs when main branch updates
    conditions:
      - -draft
      - -conflict
      - '#commits-behind>0'
    actions:
      update:
        method: merge

  # üè∑Ô∏è Auto-label Dependabot PRs
  - name: Label Dependabot PRs
    conditions:
      - author=dependabot[bot]
    actions:
      label:
        add:
          - dependencies
          - automated

  # ‚ö†Ô∏è Auto-label large PRs
  - name: Label large PRs
    conditions:
      - files-changed>20
    actions:
      label:
        add:
          - large-pr
      comment:
        message: |
          ‚ö†Ô∏è This PR is quite large ({{files-changed}} files changed).
          Consider breaking it into smaller PRs for easier review.

  # üêõ Auto-label by PR title prefix
  - name: Label bug fixes
    conditions:
      - title~=^fix(\(.*\))?:
    actions:
      label:
        add:
          - bug

  - name: Label features
    conditions:
      - title~=^feat(\(.*\))?:
    actions:
      label:
        add:
          - enhancement

  - name: Label documentation
    conditions:
      - title~=^docs(\(.*\))?:
    actions:
      label:
        add:
          - documentation

  - name: Label refactoring
    conditions:
      - title~=^refactor(\(.*\))?:
    actions:
      label:
        add:
          - refactoring

  - name: Label tests
    conditions:
      - title~=^test(\(.*\))?:
    actions:
      label:
        add:
          - tests

  # üö´ Block merge if CI fails
  - name: Block merge if checks are failing
    conditions:
      - or:
          - check-failure=TypeScript Check
          - check-failure=Lint Code
          - check-failure=Check Formatting
          - check-failure=Tests & Coverage
          - check-failure=Build Application
    actions:
      comment:
        message: |
          ‚ùå Cannot merge: CI checks are failing
          Please fix the failing checks before merging.

  # üîí Require approval for non-bot PRs
  - name: Request review for non-Dependabot PRs
    conditions:
      - -author=dependabot[bot]
      - -draft
      - '#approved-reviews-by<1'
    actions:
      comment:
        message: |
          üëÄ This PR needs at least 1 approval before merging.
          Add the `automerge` label after approval to auto-merge.
